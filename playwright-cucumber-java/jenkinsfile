pipeline {
    agent any

    environment {
        // Apuntamos DIRECTAMENTE a la copia que Jenkins sí puede leer
        KUBECONFIG = "C:/ProgramData/Jenkins/.jenkins/.kube/config"
        HTTP_PROXY = ""
        HTTPS_PROXY = ""
        NO_PROXY = "*"
    }

    stages {
        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Build & Test') {
            steps {
                dir('playwright-cucumber-java') {
                    script {
                        // Eliminamos el --server para que use lo que dice el archivo config copiado
                        bat "kubectl delete job playwright-test-job -n qa-automation --ignore-not-found=true"
                        bat "kubectl apply -f k8s/playwright-job.yaml -n qa-automation"
                        
                        echo "Esperando a Kubernetes..."
                        bat "kubectl wait --for=condition=complete job/playwright-test-job -n qa-automation --timeout=300s"
                    }
                }
            }
        }
    }
    
    post {
        always {
            dir('playwright-cucumber-java') {
                script {
                    try {
                        bat "kubectl logs -l job-name=playwright-test-job -n qa-automation"
                        junit '**/target/surefire-reports/*.xml'
                    } catch (e) {
                        echo "Todavía no hay resultados."
                    }
                }
            }
        }
    }
}