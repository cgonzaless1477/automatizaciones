pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Build & Test') {
            steps {
                dir('playwright-cucumber-java') {
                    script {
                        // Definimos la ruta donde pusiste el archivo
                        def kubeConfig = "C:/ProgramData/Jenkins/.jenkins/.kube/config"
                        
                        // Forzamos el uso del config y saltamos el proxy con 127.0.0.1
                        bat "kubectl --kubeconfig=${kubeConfig} --server=https://127.0.0.1:6443 --insecure-skip-tls-verify delete job playwright-test-job -n qa-automation --ignore-not-found=true"
                        
                        bat "kubectl --kubeconfig=${kubeConfig} --server=https://127.0.0.1:6443 --insecure-skip-tls-verify apply -f k8s/playwright-job.yaml -n qa-automation"
                        
                        echo "Esperando a Kubernetes..."
                        bat "kubectl --kubeconfig=${kubeConfig} --server=https://127.0.0.1:6443 --insecure-skip-tls-verify wait --for=condition=complete job/playwright-test-job -n qa-automation --timeout=300s"
                    }
                }
            }
        }
    }
    
    post {
        always {
            dir('playwright-cucumber-java') {
                script {
                    def kubeConfig = "C:/ProgramData/Jenkins/.jenkins/.kube/config"
                    try {
                        bat "kubectl --kubeconfig=${kubeConfig} --server=https://127.0.0.1:6443 --insecure-skip-tls-verify logs -l job-name=playwright-test-job -n qa-automation"
                        junit '**/target/surefire-reports/*.xml'
                    } catch (e) {
                        echo "AÃºn no hay resultados disponibles."
                    }
                }
            }
        }
    }
}