pipeline {
    agent any

    environment {
        // Aseguramos que Jenkins use tu llave de acceso a Kubernetes [cite: 2026-02-11]
        KUBECONFIG = "C:/ProgramData/Jenkins/.jenkins/.kube/config"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build & Test en Kubernetes') {
            steps {
                dir('playwright-cucumber-java') {
                    script {
                        // 1. Limpiamos ejecuciones anteriores para que no se mezclen logs
                        bat "kubectl delete job playwright-test-job -n qa-automation --ignore-not-found=true"

                        // 2. Lanzamos el Job
                        bat "kubectl apply -f k8s/playwright-job.yaml -n qa-automation"

                        // 3. Pequeña espera para que el Pod se cree y pase de 'Pending' a 'Running'
                        sleep 5

                        // 4. VER EL LOG EN VIVO: El parámetro -f (follow) hace que el log se imprima
                        // en la consola de Jenkins conforme los tests avanzan.
                        echo "Iniciando streaming de logs de los tests..."
                        bat "kubectl logs -f -l job-name=playwright-test-job -n qa-automation --all-containers=true"

                        // 5. Verificación final de éxito
                        bat "kubectl wait --for=condition=complete job/playwright-test-job -n qa-automation --timeout=60s"
                    }
                }
            }
        }
    }

    post {
        always {
            dir('playwright-cucumber-java') {
                script {
                    try {
                        // Opcional: Si quieres asegurar tener el log final en el post-action
                        bat "kubectl logs -l job-name=playwright-test-job -n qa-automation"
                        junit '**/target/surefire-reports/*.xml'
                    } catch (Exception e) {
                        echo "No se encontraron reportes o los tests fallaron."
                    }
                }
            }
        }
    }
}