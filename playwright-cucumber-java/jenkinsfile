pipeline {
    agent any // Usamos el agente disponible en tu Docker Desktop

    stages {
        stage('Checkout') {
            steps {
                // Descarga el código
                checkout scm
            }
        }

        stage('Build & Test en Kubernetes') {
            steps {
                // Entramos a la carpeta del proyecto
                dir('playwright-cucumber-java') {
                    // Ejecutamos el Job usando la ruta correcta al YAML
                    bat "kubectl apply -f k8s/playwright-job.yaml -n qa-automation"
                    
                    // Esperamos a que el job termine (opcional pero recomendado)
                    bat "kubectl wait --for=condition=complete job/playwright-test-job -n qa-automation --timeout=300s"
                }
            }
        }
    }

    post {
        always {
            // Corregimos el error de junit entrando a la carpeta antes de buscar
            dir('playwright-cucumber-java') {
                script {
                    try {
                        junit '**/target/surefire-reports/*.xml'
                    } catch (Exception e) {
                        echo "No se encontraron reportes junit todavía."
                    }
                }
            }
        }
    }
}