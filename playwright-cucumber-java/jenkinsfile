pipeline {
    agent any

    environment {
        // Forzamos a que kubectl busque el config en tu carpeta de usuario de Windows
        KUBECONFIG = "C:/Users/${USERPROFILE.split('\\\\').last()}/.kube/config"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build & Test en Kubernetes') {
            steps {
                dir('playwright-cucumber-java') {
                    script {
                        // 1. Limpiamos cualquier rastro del Job anterior para evitar conflictos
                        bat "kubectl delete job playwright-test-job -n qa-automation --ignore-not-found=true"
                        
                        // 2. Aplicamos el YAML sin validación externa (evita el error de login)
                        bat "kubectl apply -f k8s/playwright-job.yaml -n qa-automation --validate=false"
                        
                        // 3. Esperamos a que termine
                        echo "Esperando ejecución de Playwright..."
                        bat "kubectl wait --for=condition=complete job/playwright-test-job -n qa-automation --timeout=300s"
                    }
                }
            }
        }
    }

    post {
        always {
            dir('playwright-cucumber-java') {
                script {
                    try {
                        // Intentamos traer los logs del pod antes de terminar para que aparezcan en Jenkins
                        bat "kubectl logs -l job-name=playwright-test-job -n qa-automation --tail=-1"
                        junit '**/target/surefire-reports/*.xml'
                    } catch (Exception e) {
                        echo "No se pudieron obtener reportes o logs: ${e.message}"
                    }
                }
            }
        }
    }
}