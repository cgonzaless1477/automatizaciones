pipeline {
    agent any

    environment {
        // Forzamos a que no use Proxy para localhost y el clúster
        NO_PROXY = "localhost,127.0.0.1,kubernetes.default.svc"
        no_proxy = "localhost,127.0.0.1,kubernetes.default.svc"
        // Aseguramos la ruta del config (ajusta 'cesar' si tu usuario de Windows es distinto)
        KUBECONFIG = "C:/Users/cesar/.kube/config" 
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build & Test') {
            steps {
                dir('playwright-cucumber-java') {
                    script {
                        // Usamos --server indicando explícitamente el localhost de Docker Desktop
                        // Esto salta cualquier redirección extraña
                        bat "kubectl --server=https://kubernetes.docker.internal:6443 --insecure-skip-tls-verify delete job playwright-test-job -n qa-automation --ignore-not-found=true"
                        bat "kubectl --server=https://kubernetes.docker.internal:6443 --insecure-skip-tls-verify apply -f k8s/playwright-job.yaml -n qa-automation"
                        
                        echo "Esperando a Kubernetes..."
                        bat "kubectl wait --for=condition=complete job/playwright-test-job -n qa-automation --timeout=300s"
                    }
                }
            }
        }
    }
    
    post {
        always {
            dir('playwright-cucumber-java') {
                script {
                    try {
                        bat "kubectl logs -l job-name=playwright-test-job -n qa-automation"
                        junit '**/target/surefire-reports/*.xml'
                    } catch (e) {
                        echo "Aun no hay reportes disponibles."
                    }
                }
            }
        }
    }
}